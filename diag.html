<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScoreLeague Diagnostics</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <!-- Ensure API_BASE is injected before any dependent script -->
  <script src="/env.js"></script>
  <!-- Load odds service to expose clearOddsCache() for diagnostics -->
  <script src="/odds-api-service.js"></script>
  <style>
    html, body { background:#0f1115; color:#e6e8eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    h2 { margin: 18px 0 8px; font-size: 16px; color:#9bc7ff; }
    code, pre { background:#151924; padding: 8px; border-radius: 6px; display:block; white-space:pre-wrap; word-break:break-word; }
    .grid { display:grid; grid-template-columns: 240px 1fr; gap: 12px; align-items:start; }
    .btns { display:flex; gap:8px; margin:12px 0; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #2a3142; background:#1a2233; color:#e6e8eb; cursor:pointer; }
    button:hover { background:#223049; }
    a { color:#8ecbff; }
    .danger { background:#5a1a1a; border-color:#6a2a2a; }
    .danger:hover { background:#7a2a2a; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ScoreLeague Diagnostics</h1>
    <div class="btns">
      <button id="btn-refresh">Hard Refresh</button>
      <button id="btn-unregister">Unregister Service Worker</button>
      <button id="btn-clear">Clear Site Data (storage+caches)</button>
      <button id="btn-clear-odds-cache">Clear Odds Cache</button>
      <button id="btn-clear-open-bets-cache">Clear Open Bets Cache</button>
    </div>

    <h2>Environment</h2>
    <div class="grid">
      <div>Location</div><code id="loc"></code>
      <div>User Agent</div><code id="ua"></code>
      <div>navigator.onLine</div><code id="online"></code>
      <div>Service Worker Controller</div><code id="swc"></code>
      <div>API_BASE (window.API_BASE)</div><code id="apiBase"></code>
    </div>

    <h2>API Base Override</h2>
    <div class="grid">
      <div>Persisted localStorage api_base</div><code id="lsApiBase"></code>
      <div>Set api_base</div>
      <div>
        <input id="apiInput" type="text" placeholder="http://localhost:3001" style="width:100%; padding:6px; border-radius:6px; border:1px solid #2a3142; background:#0f1115; color:#e6e8eb;"/>
        <div class="btns" style="margin-top:8px;">
          <button id="btn-set-api">Set & Reload</button>
          <button id="btn-clear-api">Clear Override</button>
          <button id="btn-quick-local3001">Quick: localhost:3001</button>
        </div>
      </div>
    </div>

    <h2>env.js (fresh fetch, no-store)</h2>
    <pre id="envJs">(loading...)</pre>

    <h2>Proxy Health</h2>
    <div class="btns"><button id="btn-ping-api">Ping API</button></div>
    <div class="grid">
      <div>GET API_BASE/api/health</div><pre id="health">(loading...)</pre>
      <div>GET API_BASE/api/odds/sports</div><pre id="sports">(loading...)</pre>
    </div>

    <h2>Proxy Debug Headers</h2>
    <div class="btns">
      <label><input type="checkbox" id="chk-bypass" /> Bypass cache</label>
      <button id="btn-check-headers">Fetch Headers</button>
    </div>
    <div class="grid">
      <div>Sports headers</div><pre id="sportsHeaders">(loading...)</pre>
      <div>Odds headers (sport=soccer_epl)</div><pre id="oddsHeaders">(loading...)</pre>
    </div>

    <h2>Local Test Utilities</h2>
    <div class="grid">
      <div>Admin Token (optional)</div>
      <div>
        <input id="adminToken" type="password" placeholder="X-Admin-Token header" style="width:100%; padding:6px; border-radius:6px; border:1px solid #2a3142; background:#0f1115; color:#e6e8eb;" />
        <div style="margin-top:6px;"><label><input type="checkbox" id="rememberAdmin" /> Remember in this browser</label></div>
      </div>
      <div>Login/Create (nickname)</div>
      <div>
        <input id="nickname" type="text" placeholder="enter nickname" style="width:100%; padding:6px; border-radius:6px; border:1px solid #2a3142; background:#0f1115; color:#e6e8eb;" />
        <div class="btns">
          <button id="btn-login-nickname">Login</button>
        </div>
        <pre id="loginResult"></pre>
      </div>
      <div>User ID</div>
      <div>
        <input id="userId" type="text" placeholder="auto-filled after login" style="width:100%; padding:6px; border-radius:6px; border:1px solid #2a3142; background:#0f1115; color:#e6e8eb;" />
      </div>
      <div>Reset User</div>
      <div>
        <div class="btns" style="align-items:center; gap:12px;">
          <label>Coins <input id="resetCoins" type="number" value="1000" style="width:120px; margin-left:6px; padding:6px; border-radius:6px; border:1px solid #2a3142; background:#0f1115; color:#e6e8eb;" /></label>
          <label><input id="resetClearBets" type="checkbox" checked /> Clear bets</label>
        </div>
        <div class="btns">
          <button id="btn-reset-user" class="danger">Reset User</button>
        </div>
        <pre id="resetUserResult"></pre>
      </div>
      <div>Reset All</div>
      <div>
        <div class="btns">
          <button id="btn-reset-all" class="danger">RESET ALL (danger)</button>
        </div>
        <pre id="resetAllResult"></pre>
      </div>
    </div>

    <h2>Service Worker Registrations</h2>
    <pre id="swRegs">(loading...)</pre>
  </div>

  <script>
    function setEl(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      try {
        if (typeof val === 'string') el.textContent = val;
        else el.textContent = JSON.stringify(val, null, 2);
      } catch (e) {
        el.textContent = String(val);
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', () => {
      // Force a full reload bypassing SW caches
      location.reload(true);
    });

    document.getElementById('btn-unregister').addEventListener('click', async () => {
      if (!('serviceWorker' in navigator)) return alert('No serviceWorker in this browser');
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));
      alert('Service worker(s) unregistered. Reloading...');
      location.reload();
    });

    document.getElementById('btn-clear').addEventListener('click', async () => {
      try {
        // Clear caches
        if (window.caches) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
        // Clear storage (local/session/indexedDB) best-effort
        localStorage.clear();
        sessionStorage.clear();
        if (window.indexedDB && indexedDB.databases) {
          const dbs = await indexedDB.databases();
          await Promise.all(dbs.map(db => db && db.name ? new Promise(res => {
            const req = indexedDB.deleteDatabase(db.name);
            req.onsuccess = req.onerror = req.onblocked = () => res();
          }) : Promise.resolve()));
        }
        alert('Cleared site data and caches. Reloading...');
        location.reload();
      } catch (e) {
        alert('Clear failed: ' + e);
      }
    });

    document.getElementById('btn-clear-odds-cache').addEventListener('click', () => {
      try {
        if (window.clearOddsCache) {
          window.clearOddsCache();
          alert('In-memory odds cache cleared.');
        } else {
          alert('clearOddsCache() not available on this page.');
        }
      } catch (e) {
        alert('Failed to clear odds cache: ' + e);
      }
    });

    // Clear Open Bets cache (works even if multiuser_client scripts are not loaded)
    document.getElementById('btn-clear-open-bets-cache').addEventListener('click', () => {
      try {
        if (typeof window.clearOpenBetsCache === 'function') {
          window.clearOpenBetsCache();
        } else {
          // Fallback: remove persisted key so other tabs drop in-memory cache via `storage` event
          localStorage.removeItem('open_bets_cache');
        }
        alert('Open Bets cache cleared.');
      } catch (e) {
        alert('Failed to clear Open Bets cache: ' + e);
      }
    });

    // API base override controls
    document.getElementById('btn-set-api').addEventListener('click', () => {
      try {
        const v = String(document.getElementById('apiInput').value || '').trim();
        if (!v) return alert('Enter a value');
        localStorage.setItem('api_base', v);
        alert('api_base saved. Reloading...');
        location.href = '/diag.html';
      } catch (e) {
        alert('Failed to set api_base: ' + e);
      }
    });
    document.getElementById('btn-clear-api').addEventListener('click', () => {
      try {
        localStorage.removeItem('api_base');
        alert('api_base cleared. Reloading...');
        location.href = '/diag.html';
      } catch (e) {
        alert('Failed to clear api_base: ' + e);
      }
    });
    document.getElementById('btn-quick-local3001').addEventListener('click', () => {
      try {
        localStorage.setItem('api_base', 'http://localhost:3001');
        alert('api_base set to http://localhost:3001. Reloading...');
        location.href = '/diag.html';
      } catch (e) {
        alert('Failed to set api_base: ' + e);
      }
    });

    // Manual ping of API endpoints
    document.getElementById('btn-ping-api').addEventListener('click', async () => {
      const base = window.API_BASE;
      if (!base) {
        setEl('health', 'window.API_BASE is empty');
        setEl('sports', 'window.API_BASE is empty');
        return;
      }
      try {
        const health = await fetch(base + '/api/health', { cache: 'no-store' }).then(r => r.json());
        setEl('health', health);
      } catch (e) {
        const msg = ((e && e.name === 'AbortError') || /aborted/i.test(String((e && e.message) || e)))
          ? 'ABORTED (neutral)'
          : 'ERROR: ' + ((e && e.message) || e);
        setEl('health', msg);
      }
      try {
        const sports = await fetch(base + '/api/odds/sports', { cache: 'no-store' }).then(r => r.json());
        setEl('sports', Array.isArray(sports) ? sports.slice(0, 10) : sports);
      } catch (e) {
        const msg = ((e && e.name === 'AbortError') || /aborted/i.test(String((e && e.message) || e)))
          ? 'ABORTED (neutral)'
          : 'ERROR: ' + ((e && e.message) || e);
        setEl('sports', msg);
      }
    });

    async function fetchProxyHeaders() {
      const base = window.API_BASE;
      if (!base) {
        setEl('sportsHeaders', 'window.API_BASE is empty');
        setEl('oddsHeaders', 'window.API_BASE is empty');
        return;
      }
      const bypass = !!(document.getElementById('chk-bypass') && document.getElementById('chk-bypass').checked);
      try {
        const sportsUrl = base + '/api/odds/sports' + (bypass ? '?bypass_cache=1' : '');
        const r1 = await fetch(sportsUrl, { cache: 'no-store' });
        const info1 = {
          status: r1.status,
          'X-Proxy-Mode': r1.headers.get('X-Proxy-Mode') || '(none)',
          'X-Cache-Key': r1.headers.get('X-Cache-Key') || '(none)',
          'X-Upstream-Status': r1.headers.get('X-Upstream-Status') || '(none)'
        };
        setEl('sportsHeaders', info1);
      } catch (e) {
        setEl('sportsHeaders', 'ERROR: ' + ((e && e.message) || e));
      }
      try {
        const oddsUrl = base + '/api/odds?sport=soccer_epl' + (bypass ? '&bypass_cache=1' : '');
        const r2 = await fetch(oddsUrl, { cache: 'no-store' });
        const info2 = {
          status: r2.status,
          'X-Proxy-Mode': r2.headers.get('X-Proxy-Mode') || '(none)',
          'X-Cache-Key': r2.headers.get('X-Cache-Key') || '(none)',
          'X-Upstream-Status': r2.headers.get('X-Upstream-Status') || '(none)'
        };
        setEl('oddsHeaders', info2);
      } catch (e) {
        setEl('oddsHeaders', 'ERROR: ' + ((e && e.message) || e));
      }
    }

    document.getElementById('btn-check-headers').addEventListener('click', fetchProxyHeaders);

    function getApiBaseStrict() {
      const base = window.API_BASE;
      if (!base) throw new Error('window.API_BASE is empty');
      return base;
    }
    function getAdminToken() {
      const el = document.getElementById('adminToken');
      return el ? String(el.value || '').trim() : '';
    }
    function maybeAddAdminHeader(headers) {
      try {
        const tok = getAdminToken();
        if (tok) headers['X-Admin-Token'] = tok;
      } catch (e) { /* ignore */ }
    }
    function setPre(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      try { el.textContent = typeof val === 'string' ? val : JSON.stringify(val, null, 2); }
      catch (e) { el.textContent = String(val); }
    }
    // Remember admin token
    (function wireAdminRemember() {
      const chk = document.getElementById('rememberAdmin');
      const inp = document.getElementById('adminToken');
      if (!chk || !inp) return;
      const syncSave = () => {
        try {
          if (chk.checked && inp.value) localStorage.setItem('diag_admin_token', inp.value);
          else localStorage.removeItem('diag_admin_token');
        } catch (e) { /* ignore */ }
      };
      chk.addEventListener('change', syncSave);
      inp.addEventListener('input', () => { if (chk.checked) syncSave(); });
    })();
    // Login (nickname)
    document.getElementById('btn-login-nickname').addEventListener('click', async () => {
      try {
        const base = getApiBaseStrict();
        const username = String(document.getElementById('nickname').value || '').trim();
        if (username.length < 2) return alert('Enter a nickname (min 2 chars)');
        const r = await fetch(base + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const data = await r.json();
        setPre('loginResult', data);
        if (data && data.user && data.user.id) {
          document.getElementById('userId').value = data.user.id;
          try {
            localStorage.setItem('diag_user_id', data.user.id);
            localStorage.setItem('diag_username', data.user.username || username);
          } catch (e) { /* ignore */ }
        }
      } catch (e) {
        setPre('loginResult', 'ERROR: ' + ((e && e.message) || e));
      }
    });
    // Reset user
    document.getElementById('btn-reset-user').addEventListener('click', async () => {
      try {
        const base = getApiBaseStrict();
        const userId = String(document.getElementById('userId').value || '').trim();
        if (!userId) return alert('Enter userId');
        const coins = parseInt(document.getElementById('resetCoins').value || '1000', 10) || 1000;
        const clearBets = !!document.getElementById('resetClearBets').checked;
        const headers = { 'Content-Type': 'application/json' };
        maybeAddAdminHeader(headers);
        const r = await fetch(base + '/api/debug/reset-user', {
          method: 'POST',
          headers,
          body: JSON.stringify({ userId, coins, clearBets })
        });
        const data = await r.json();
        setPre('resetUserResult', data);
      } catch (e) {
        setPre('resetUserResult', 'ERROR: ' + ((e && e.message) || e));
      }
    });
    // Reset all
    document.getElementById('btn-reset-all').addEventListener('click', async () => {
      try {
        if (!confirm('This will clear ALL users, leagues and bets on the server and re-seed demo matches. Continue?')) return;
        const base = getApiBaseStrict();
        const headers = { 'Content-Type': 'application/json' };
        maybeAddAdminHeader(headers);
        const r = await fetch(base + '/api/debug/reset-all', { method: 'POST', headers, body: JSON.stringify({}) });
        const data = await r.json();
        setPre('resetAllResult', data);
      } catch (e) {
        setPre('resetAllResult', 'ERROR: ' + ((e && e.message) || e));
      }
    });

    (async function main() {
      setEl('loc', location.href);
      setEl('ua', navigator.userAgent);
      setEl('online', String(navigator.onLine));
      setEl('swc', navigator.serviceWorker && navigator.serviceWorker.controller ? 'YES' : 'NO');
      setEl('apiBase', typeof window !== 'undefined' ? String(window.API_BASE || '(empty)') : '(no window)');
      try {
        const lsApi = localStorage.getItem('api_base');
        setEl('lsApiBase', lsApi || '(none)');
        const input = document.getElementById('apiInput');
        if (input) {
          input.value = lsApi || (window.API_BASE || '');
          input.placeholder = window.API_BASE || 'http://localhost:3001';
        }
      } catch (e) { /* ignore */ }

      // Fetch env.js fresh
      try {
        const envTxt = await fetch('/env.js', { cache: 'no-store' }).then(r => r.text());
        setEl('envJs', envTxt);
      } catch (e) {
        setEl('envJs', 'ERROR: ' + (e && e.message || e));
      }

      // Proxy checks
      if (window.API_BASE) {
        try {
          const health = await fetch(window.API_BASE + '/api/health').then(r => r.json());
          setEl('health', health);
        } catch (e) {
          // Treat AbortError as neutral (often caused by reload/navigation)
          const msg = ((e && e.name === 'AbortError') || /aborted/i.test(String((e && e.message) || e)))
            ? 'ABORTED (neutral)'
            : 'ERROR: ' + ((e && e.message) || e);
          setEl('health', msg);
        }
        try {
          const sports = await fetch(window.API_BASE + '/api/odds/sports').then(r => r.json());
          setEl('sports', Array.isArray(sports) ? sports.slice(0, 10) : sports);
        } catch (e) {
          // Treat AbortError as neutral (often caused by reload/navigation)
          const msg = ((e && e.name === 'AbortError') || /aborted/i.test(String((e && e.message) || e)))
            ? 'ABORTED (neutral)'
            : 'ERROR: ' + ((e && e.message) || e);
          setEl('sports', msg);
        }
      } else {
        setEl('health', 'window.API_BASE is empty');
        setEl('sports', 'window.API_BASE is empty');
        setEl('sportsHeaders', 'window.API_BASE is empty');
        setEl('oddsHeaders', 'window.API_BASE is empty');
      }

      // Auto-run header fetch if API_BASE is present
      if (window.API_BASE) {
        try { await fetchProxyHeaders(); } catch (e) { /* ignore */ }
      }

      // Prefill saved admin token and userId
      try {
        const savedAdmin = localStorage.getItem('diag_admin_token');
        if (savedAdmin) {
          const adminEl = document.getElementById('adminToken');
          const chk = document.getElementById('rememberAdmin');
          if (adminEl) adminEl.value = savedAdmin;
          if (chk) chk.checked = true;
        }
        const savedUser = localStorage.getItem('diag_user_id');
        if (savedUser) {
          const uel = document.getElementById('userId');
          if (uel) uel.value = savedUser;
        }
        const savedNick = localStorage.getItem('diag_username');
        if (savedNick) {
          const nel = document.getElementById('nickname');
          if (nel) nel.value = savedNick;
        }
      } catch (e) { /* ignore */ }

      // List SW registrations
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          const info = await Promise.all(regs.map(async r => ({
            scope: r.scope,
            active: r.active && r.active.scriptURL,
            installing: r.installing && r.installing.scriptURL,
            waiting: r.waiting && r.waiting.scriptURL
          })));
          setEl('swRegs', info);
        } else {
          setEl('swRegs', 'serviceWorker not supported');
        }
      } catch (e) {
        setEl('swRegs', 'ERROR: ' + (e && e.message || e));
      }
    })();
  </script>
</body>
</html>
